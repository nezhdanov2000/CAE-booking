<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Management - CAE System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
    <style>
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .add-course-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .add-course-btn:hover {
            background-color: #059669;
        }
        
        .course-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .course-table th,
        .course-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .course-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #475569;
        }
        
        .course-table tr:hover {
            background-color: #f8fafc;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-delete {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit:hover {
            background-color: #2563eb;
        }
        
        .btn-delete:hover {
            background-color: #dc2626;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 300px;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .stats-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background-color: #e2e8f0;
            color: #475569;
        }
        
        .warning-badge {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .danger-badge {
            background-color: #fef2f2;
            color: #991b1b;
        }
        
        .success-badge {
            background-color: #dcfce7;
            color: #166534;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Course Management</h1>
            <div>
                <button class="btn-edit" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="course-header">
            <div class="search-box">
                <input type="text" id="course-search" placeholder="Search courses..." onkeyup="filterCourses()">
            </div>
            <button class="add-course-btn" onclick="showAddCourseModal()">Add New Course</button>
        </div>

        <table class="course-table" id="courses-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Course Name</th>
                    <th>Students</th>
                    <th>Tutors</th>
                    <th>Timeslots</th>
                    <th>Appointments</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="courses-tbody">
                <tr>
                    <td colspan="8">Loading courses...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Add Course Modal -->
    <div id="add-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 8px; min-width: 400px;">
            <h3>Add New Course</h3>
            <form id="add-course-form">
                <div class="form-group">
                    <label for="course-name">Course Name</label>
                    <input type="text" id="course-name" name="course-name" required>
                </div>
                
                <div class="form-group">
                    <label for="course-description">Description (optional)</label>
                    <textarea id="course-description" name="course-description" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn-submit">Add Course</button>
                    <button type="button" class="btn-delete" onclick="closeAddModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 8px; min-width: 400px;">
            <h3>Edit Course</h3>
            <form id="edit-course-form">
                <input type="hidden" id="edit-course-id" name="course-id">
                
                <div class="form-group">
                    <label for="edit-course-name">Course Name</label>
                    <input type="text" id="edit-course-name" name="course-name" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-course-description">Description (optional)</label>
                    <textarea id="edit-course-description" name="course-description" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn-submit">Save Changes</button>
                    <button type="button" class="btn-delete" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 8px; min-width: 400px;">
            <h3>Delete Course</h3>
            <div id="delete-warning" style="margin-bottom: 20px;">
                <p>Are you sure you want to delete this course?</p>
                <div id="delete-details" style="background: #fef2f2; border: 1px solid #fecaca; padding: 12px; border-radius: 6px; margin-top: 10px; display: none;">
                    <p style="color: #991b1b; margin: 0;"><strong>⚠️ Warning:</strong> This course has active appointments and students enrolled.</p>
                    <p style="color: #991b1b; margin: 5px 0 0 0;">You must remove all appointments first before deleting this course.</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button id="confirm-delete-btn" class="btn-delete" onclick="confirmDeleteCourse()">Delete Course</button>
                <button class="btn-edit" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentCourses = [];
        let courseToDelete = null;

        // Load courses
        async function loadCourses() {
            try {
                const response = await fetch('/CAE/backend/admin/get_courses.php');
                const data = await response.json();
                
                if (data.success) {
                    currentCourses = data.data.courses;
                    displayCourses(data.data.courses);
                }
            } catch (err) {
                console.error('Error loading courses:', err);
                document.getElementById('courses-tbody').innerHTML = '<tr><td colspan="8">Error loading courses</td></tr>';
            }
        }

        // Display courses
        function displayCourses(courses) {
            const tbody = document.getElementById('courses-tbody');
            tbody.innerHTML = '';
            
            courses.forEach(course => {
                const row = document.createElement('tr');
                
                // Determine status badge
                let statusBadge = '';
                if (course.appointments > 0) {
                    statusBadge = `<span class="stats-badge danger-badge">Has Appointments</span>`;
                } else if (course.students > 0) {
                    statusBadge = `<span class="stats-badge warning-badge">Has Students</span>`;
                } else if (course.tutors > 0) {
                    statusBadge = `<span class="stats-badge success-badge">Active</span>`;
                } else {
                    statusBadge = `<span class="stats-badge">Inactive</span>`;
                }
                
                row.innerHTML = `
                    <td>${course.Course_ID}</td>
                    <td>${course.Course_name}</td>
                    <td><span class="stats-badge">${course.students}</span></td>
                    <td><span class="stats-badge">${course.tutors}</span></td>
                    <td><span class="stats-badge">${course.timeslots}</span></td>
                    <td><span class="stats-badge">${course.appointments}</span></td>
                    <td>${statusBadge}</td>
                    <td class="action-buttons">
                        <button class="btn-edit" onclick="editCourse(${course.Course_ID})">Edit</button>
                        <button class="btn-delete" onclick="deleteCourse(${course.Course_ID})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter courses
        function filterCourses() {
            const searchTerm = document.getElementById('course-search').value.toLowerCase();
            const filtered = currentCourses.filter(course => 
                course.Course_name.toLowerCase().includes(searchTerm)
            );
            displayCourses(filtered);
        }

        // Show add course modal
        function showAddCourseModal() {
            document.getElementById('add-modal').style.display = 'block';
        }

        // Close add modal
        function closeAddModal() {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('add-course-form').reset();
        }

        // Show edit course modal
        async function editCourse(courseId) {
            const course = currentCourses.find(c => c.Course_ID === courseId);
            if (!course) return;
            
            document.getElementById('edit-course-id').value = courseId;
            document.getElementById('edit-course-name').value = course.Course_name;
            document.getElementById('edit-course-description').value = course.Description || '';
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // Show delete confirmation modal
        async function deleteCourse(courseId) {
            const course = currentCourses.find(c => c.Course_ID === courseId);
            if (!course) return;
            
            courseToDelete = course;
            
            const deleteDetails = document.getElementById('delete-details');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            
            if (course.appointments > 0) {
                deleteDetails.style.display = 'block';
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Cannot Delete (Has Appointments)';
                confirmBtn.style.backgroundColor = '#9ca3af';
            } else {
                deleteDetails.style.display = 'none';
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Delete Course';
                confirmBtn.style.backgroundColor = '#ef4444';
            }
            
            document.getElementById('delete-modal').style.display = 'block';
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            courseToDelete = null;
        }

        // Confirm delete course
        async function confirmDeleteCourse() {
            if (!courseToDelete) return;
            
            if (courseToDelete.appointments > 0) {
                alert('Cannot delete course with active appointments. Please remove all appointments first.');
                return;
            }
            
            try {
                const response = await fetch('/CAE/backend/admin/delete_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ course_id: courseToDelete.Course_ID })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Course deleted successfully!');
                    closeDeleteModal();
                    loadCourses();
                } else {
                    alert('Error: ' + data.data.error);
                }
            } catch (err) {
                console.error('Error deleting course:', err);
                alert('Error deleting course');
            }
        }

        // Add course form submission
        document.getElementById('add-course-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const courseData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/CAE/backend/admin/add_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(courseData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Course added successfully!');
                    closeAddModal();
                    loadCourses();
                } else {
                    alert('Error: ' + data.data.error);
                }
            } catch (err) {
                console.error('Error adding course:', err);
                alert('Error adding course');
            }
        });

        // Edit course form submission
        document.getElementById('edit-course-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const courseData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/CAE/backend/admin/update_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(courseData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Course updated successfully!');
                    closeEditModal();
                    loadCourses();
                } else {
                    alert('Error: ' + data.data.error);
                }
            } catch (err) {
                console.error('Error updating course:', err);
                alert('Error updating course');
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/CAE/backend/admin/logout.php')
                    .then(() => {
                        window.location.href = 'login.html';
                    })
                    .catch(err => {
                        console.error('Logout error:', err);
                        window.location.href = 'login.html';
                    });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCourses();
        });
    </script>
</body>
</html>
