<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Recurring Slots - CAE</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        .recurring-slots-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px;
        }
        
        .slots-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .slots-table th,
        .slots-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .slots-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .slots-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-active {
            color: #28a745;
            font-weight: 600;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: 600;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 14px;
        }
        
        .edit-btn {
            background: #007bff;
            color: white;
        }
        
        .edit-btn:hover {
            background: #0056b3;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .toggle-btn {
            background: #28a745;
            color: white;
        }
        
        .toggle-btn.inactive {
            background: #6c757d;
        }
        
        .no-slots {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .back-link {
            display: inline-block;
            margin: 20px;
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .create-new-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .create-new-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Logo">
                <div class="user-name" id="sidebarUserName">User</div>
            </div>
            <div class="sidebar-menu">
                <a href="../common/dashboard.html"><i class="fa fa-university"></i> Institution Page</a>
                <a href="../common/schedule.html"><i class="fa fa-calendar"></i> Schedule</a>
                <a href="#"><i class="fa fa-user"></i> <span id="sidebarUserShort"></span></a>
                <a href="#"><i class="fa fa-bolt"></i> Activity</a>
                <a href="#"><i class="fa fa-book"></i> Courses</a>
                <a href="#"><i class="fa fa-envelope"></i> Messages</a>
                <a href="#"><i class="fa fa-graduation-cap"></i> Grades</a>
                <a href="#"><i class="fa fa-wrench"></i> Tools</a>
                <a href="../../backend/common/logout.php"><i class="fa fa-sign-out-alt"></i> Sign Out</a>
            </div>
            <div class="sidebar-footer">
                <div>Privacy &nbsp; | &nbsp; Terms &nbsp; | &nbsp; Accessibility</div>
            </div>
        </nav>
        <main class="main-content">
            <a href="../common/dashboard.html" class="back-link">
                <i class="fa fa-arrow-left"></i> Back to Dashboard
            </a>
            
            <div class="recurring-slots-container">
                <h2><i class="fa fa-calendar-check"></i> Manage Recurring Slots</h2>
                <p>View and manage your regular weekly slots that automatically repeat every week.</p>
                
                <a href="create_recurring_slots.html" class="create-new-btn">
                    <i class="fa fa-plus"></i> Create New Recurring Slot
                </a>
                
                <div id="slotsTable">
                    <table class="slots-table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="slotsTableBody">
                            <!-- Slots will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noSlots" class="no-slots" style="display: none;">
                    <i class="fa fa-calendar-times fa-3x"></i>
                    <h3>No Recurring Slots Found</h3>
                    <p>You haven't created any recurring slots yet.</p>
                    <a href="create_recurring_slots.html" class="create-new-btn">
                        <i class="fa fa-plus"></i> Create Your First Recurring Slot
                    </a>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Fetch user data and populate sidebar
        fetch('../../backend/common/dashboard.php')
            .then(response => response.json())
            .then(data => {
                document.getElementById('sidebarUserName').textContent = data.name + ' ' + data.surname;
                document.getElementById('sidebarUserShort').textContent = data.name;
                
                // Check if user is a tutor
                if (data.role !== 'tutor') {
                    window.location.href = '../common/dashboard.html';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.location.href = '../common/login.html';
            });
        
        // Load recurring slots
        function loadRecurringSlots() {
            fetch('../../backend/tutor/get_recurring_slots.php')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('slotsTableBody');
                    const noSlots = document.getElementById('noSlots');
                    const slotsTable = document.getElementById('slotsTable');
                    
                    if (data.length === 0) {
                        noSlots.style.display = 'block';
                        slotsTable.style.display = 'none';
                        return;
                    }
                    
                    noSlots.style.display = 'none';
                    slotsTable.style.display = 'block';
                    
                    tableBody.innerHTML = '';
                    
                    data.forEach(slot => {
                        const row = document.createElement('tr');
                        
                        const dayNames = {
                            'monday': 'Monday',
                            'tuesday': 'Tuesday',
                            'wednesday': 'Wednesday',
                            'thursday': 'Thursday',
                            'friday': 'Friday',
                            'saturday': 'Saturday',
                            'sunday': 'Sunday'
                        };
                        
                        const statusClass = slot.Is_Active ? 'status-active' : 'status-inactive';
                        const statusText = slot.Is_Active ? 'Active' : 'Inactive';
                        const toggleText = slot.Is_Active ? 'Deactivate' : 'Activate';
                        const toggleClass = slot.Is_Active ? '' : 'inactive';
                        
                        row.innerHTML = `
                            <td>${slot.Course_name}</td>
                            <td>${dayNames[slot.Day_Of_Week]}</td>
                            <td>${slot.Start_Time} - ${slot.End_Time}</td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>${new Date(slot.Created_At).toLocaleDateString()}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editSlot(${slot.Recurring_ID})">
                                    <i class="fa fa-edit"></i> Edit
                                </button>
                                <button class="action-btn toggle-btn ${toggleClass}" onclick="toggleSlot(${slot.Recurring_ID}, ${slot.Is_Active})">
                                    <i class="fa fa-${slot.Is_Active ? 'pause' : 'play'}"></i> ${toggleText}
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteSlot(${slot.Recurring_ID})">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading slots:', error);
                });
        }
        
        // Toggle slot status
        function toggleSlot(slotId, currentStatus) {
            const newStatus = currentStatus ? 0 : 1;
            const action = currentStatus ? 'deactivate' : 'activate';
            
            if (confirm(`Are you sure you want to ${action} this recurring slot?`)) {
                fetch('../../backend/tutor/toggle_recurring_slot.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        slotId: slotId,
                        isActive: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecurringSlots();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Network error occurred');
                });
            }
        }
        
        // Delete slot
        function deleteSlot(slotId) {
            if (confirm('Are you sure you want to delete this recurring slot? This action cannot be undone.')) {
                fetch('../../backend/tutor/delete_recurring_slot.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        slotId: slotId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecurringSlots();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Network error occurred');
                });
            }
        }
        
        // Edit slot (redirect to edit page)
        function editSlot(slotId) {
            // For now, redirect to create page with edit mode
            // In a full implementation, you'd create a separate edit page
            alert('Edit functionality will be implemented in the next version.');
        }
        
        // Load slots when page loads
        document.addEventListener('DOMContentLoaded', loadRecurringSlots);
    </script>
</body>
</html>
